<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FePe – Aislamiento Criogénico v03b (Corregido: Radiación + Verificación 10.9 in)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net/npm" crossorigin>
<style>
  :root{--ink:#000;--bg:#fff;}
  html,body{margin:0;padding:0;background:#fff;color:#000;font-family:Arial,Helvetica,sans-serif}
  header{padding:16px 20px;border-bottom:2px solid #000}
  header h1{margin:0 0 6px 0;font-size:20px}
  header p{margin:0;font-size:12px;opacity:.9}
  main{display:grid;grid-template-columns:430px 1fr;gap:18px;padding:16px 20px 28px}
  .card{border:1px solid #000;border-radius:4px;padding:12px}
  .card h2{margin:0 0 8px 0;font-size:14px;text-transform:uppercase;letter-spacing:.4px}
  label{display:block;font-size:12px;margin:6px 0 2px}
  input{width:100%;box-sizing:border-box;padding:7px 8px;font-size:13px;border:1px solid #000;border-radius:4px;background:#fff}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px 12px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px 12px}
  .actions{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
  button{padding:10px 12px;border:2px solid #000;background:#fff;font-weight:700;cursor:pointer}
  button:active{transform:translateY(1px)}
  canvas{background:#fff;border:1px solid #000}
  table{border-collapse:collapse;width:100%;font-size:13px;margin-top:8px}
  th,td{border:1px solid #000;padding:6px 8px;text-align:left;vertical-align:top}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;font-size:12px}
  .muted{opacity:.85;font-size:12px}
  .status-ok{color:#087f23;font-weight:700}
  .status-bad{color:#b00020;font-weight:700}
  footer{padding:10px 20px;border-top:2px solid #000;font-size:11px;display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}
  @media(max-width:980px){ main{grid-template-columns:1fr} }
  @media print{@page{size:Letter portrait;margin:12mm} header,.no-print,footer{display:none!important} main{grid-template-columns:1fr;gap:0;padding:0} .card{border:none;padding:0} canvas{border:1px solid #000}}
</style>
</head>
<body>
<header>
  <h1>=== FePe – Aislamiento Criogénico v03b (Corregido) ===</h1>
  <p>Correcciones: radiación externa (ε), iteración h_ext = h_conv + h_rad, tope 20″, k_PUR(T) iterativo. Verificación fija 10.9 in ±5%. Capas 4+4+resto. BV dentro del PUR con protección; chaqueta 1 mm.</p>
</header>

<main>
  <section class="card">
    <h2>Entrada</h2>
    <div class="grid2">
      <div><label>Nombre del caso</label><input id="nombre" value="Columna_24in_-160C"/></div>
      <div><label>Longitud L (m)</label><input id="L" type="number" step="0.01" value="1.0"/></div>
      <div><label>Diámetro interno (in)</label><input id="d_in" type="number" step="0.001" value="24"/></div>
      <div><label>Espesor pared (in)</label><input id="t_pared" type="number" step="0.001" value="0.375"/></div>
    </div>

    <h2>Ambiente y proceso</h2>
    <div class="grid3">
      <div><label>T proceso (°C)</label><input id="T_in" type="number" step="0.1" value="-160"/></div>
      <div><label>T ambiente (°C)</label><input id="T_out" type="number" step="0.1" value="35"/></div>
      <div><label>Altitud (m s.n.m.)</label><input id="alt" type="number" step="1" value="0"/></div>
      <div><label>Humedad relativa φ (0–1)</label><input id="phi" type="number" step="0.01" value="0.60"/></div>
      <div><label>Margen sobre T_rocío (°C)</label><input id="margendew" type="number" step="0.1" value="2"/></div>
      <div><label>Margen 0 °C para BV (°C)</label><input id="margen0" type="number" step="0.1" value="0.5"/></div>
    </div>

    <h2>Películas y materiales</h2>
    <div class="grid3">
      <div><label>h_interna (W/m²·K)</label><input id="h_in" type="number" step="1" value="500"/></div>
      <div><label>h_ext_conv (W/m²·K)</label><input id="h_out_conv" type="number" step="1" value="8"/></div>
      <div><label>Emisividad ε (chaqueta)</label><input id="eps" type="number" step="0.01" value="0.10"/></div>
      <div><label>k acero (W/m·K)</label><input id="k_acero" type="number" step="0.1" value="16"/></div>
      <div><label>a PUR [W/m·K] a 25°C</label><input id="k_a" type="number" step="0.0001" value="0.024"/></div>
      <div><label>b PUR [W/m·K/°C]</label><input id="k_b" type="number" step="0.000001" value="0.00012"/></div>
      <div><label>ρ PUR (kg/m³)</label><input id="rho_pur" type="number" step="0.1" value="35"/></div>
    </div>

    <h2>Construcción</h2>
    <div class="grid3">
      <div><label>Chaqueta Al (mm)</label><input id="t_al_mm" type="number" step="0.1" value="1.0"/></div>
      <div><label>k Al (W/m·K)</label><input id="k_al" type="number" step="0.1" value="160"/></div>
      <div><label>Protección mínima sobre BV (in)</label><input id="t_guard" type="number" step="0.1" value="0.50"/></div>
      <div><label>Espesor máx/capa (in)</label><input id="tcapamax" type="number" step="0.1" value="4.0"/></div>
      <div><label>Mínimo de capas</label><input id="ncapamin" type="number" step="1" value="3"/></div>
      <div><label>N° máx de capas</label><input id="ncapamax" type="number" step="1" value="6"/></div>
    </div>

    <div class="actions">
      <button id="btnDisenar">Diseñar</button>
      <button id="btnImprimir" class="no-print">Imprimir (Carta)</button>
      <button id="btnPNG" class="no-print">Descargar PNG</button>
    </div>
    <p class="muted">h_ext = h_conv + h_rad(ε). BV dentro del PUR donde T(r)≥0°C+margen y con ≥ t_guard de PUR por fuera (nunca bajo la chaqueta). Verificación FePe fija (10.9 in ±5%).</p>
  </section>

  <section class="card">
    <h2>Lámina – Perfil tipo pizarrón</h2>
    <canvas id="chart" width="1000" height="650"></canvas>
    <table id="tabla"></table>
    <div class="mono" id="capas"></div>
    <div class="mono" id="bvtext"></div>
    <div class="mono" id="veritext"></div>
  </section>
</main>

<footer>
  <div>© 2025 FePe – Cryogenic PUR System | Español técnico | Carta 8.5×11 in</div>
  <div>Firma automática: F. Peluffo – Octubre 2025</div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
const IN_TO_M=0.0254, FT_TO_M=0.3048, W_TO_BTU_H=3.412141633, SIG=5.670374419e-8;
const TREF_INCH=10.9, TREF_TOL=0.05;

function dewPointC(Tc, phi){ const a=17.27,b=237.7; const A=((a*Tc)/(b+Tc))+Math.log(phi); return (b*A)/(a-A); }
const Rconv=(h,r,L)=> h>0? 1/(h*2*Math.PI*r*L) : 0;
const Rcond=(k,r1,r2,L)=> Math.log(r2/r1)/(2*Math.PI*k*L);
const kPUR=(Tc,a,b)=> a + b*(Tc-25.0);

function solveWithThickness(inp, t_pur_in){
  const r_in=(inp.d_in*IN_TO_M)/2, r_pared_ext=r_in + inp.t_pared*IN_TO_M;
  const r_PUR_ext=r_pared_ext + t_pur_in*IN_TO_M, r_AL_ext=r_PUR_ext + (inp.t_al_mm/1000);
  const Rci=Rconv(inp.h_in, r_in, inp.L), Rsteel=Rcond(inp.k_acero, r_in, r_pared_ext, inp.L), Ral=Rcond(inp.k_al, r_PUR_ext, r_AL_ext, inp.L);

  let kpur=kPUR((inp.T_in+inp.T_out)/2, inp.k_a, inp.k_b);
  let T_AL_solid_guess = inp.T_out; // start near ambient
  for(let outer=0; outer<40; outer++){
    const T_s = T_AL_solid_guess + 273.15, T_inf = inp.T_out + 273.15;
    const h_rad = inp.eps * SIG * (T_s + T_inf) * (T_s*T_s + T_inf*T_inf);
    const h_ext = inp.h_out_conv + h_rad;
    const Rco=Rconv(h_ext, r_AL_ext, inp.L);
    // iterate kpur with this h_ext
    let kcur=kpur;
    for(let i=0;i<30;i++){
      const Rtot=Rci+Rsteel+Rcond(kcur,r_pared_ext,r_PUR_ext,inp.L)+Ral+Rco;
      const q=(inp.T_in-inp.T_out)/Rtot;
      const RhAL=Rci+Rsteel+Rcond(kcur,r_pared_ext,r_PUR_ext,inp.L)+Ral;
      const T_AL = inp.T_in - q*RhAL; // solid surface
      const knew = kPUR((inp.T_in+T_AL)/2, inp.k_a, inp.k_b);
      if (Math.abs(knew-kcur)<1e-6){ kcur=knew; T_AL_solid_guess=T_AL; break; }
      kcur=knew; T_AL_solid_guess=T_AL;
    }
    // recompute with updated h_ext based on new T_AL
    const T_s2 = T_AL_solid_guess + 273.15;
    const h_rad2 = inp.eps * SIG * (T_s2 + T_inf) * (T_s2*T_s2 + T_inf*T_inf);
    const h_ext2 = inp.h_out_conv + h_rad2;
    const Rco2=Rconv(h_ext2, r_AL_ext, inp.L);
    const Rtot2=Rci+Rsteel+Rcond(kcur,r_pared_ext,r_PUR_ext,inp.L)+Ral+Rco2;
    const q2=(inp.T_in-inp.T_out)/Rtot2;
    const RhAL2=Rci+Rsteel+Rcond(kcur,r_pared_ext,r_PUR_ext,inp.L)+Ral;
    const T_AL2 = inp.T_in - q2*RhAL2;
    if (Math.abs(T_AL2 - T_AL_solid_guess) < 1e-3){
      // Assemble T(r)
      const N=200, rlist=[], Tlist=[];
      for(let i=0;i<=N;i++){ rlist.push(r_in + (r_AL_ext - r_in)*i/N); }
      const Tstart=inp.T_in - q2*Rci;
      for(let i=0;i<rlist.length;i++){ const r=rlist[i];
        if(r<=r_pared_ext){ const frac=Math.log(r/r_in)/Math.log(r_pared_ext/r_in); const dT=q2*Rcond(inp.k_acero, r_in, r_pared_ext, 1.0); Tlist[i]=Tstart - frac*dT; }
        else if(r<=r_PUR_ext){ const dTsteel=q2*Rcond(inp.k_acero, r_in, r_pared_ext, 1.0); const frac=Math.log(r/r_pared_ext)/Math.log(r_PUR_ext/r_pared_ext); const dTpur=q2*Rcond(kcur, r_pared_ext, r_PUR_ext, 1.0); Tlist[i]=Tstart - dTsteel - frac*dTpur; }
        else{ const dTsteel=q2*Rcond(inp.k_acero, r_in, r_pared_ext, 1.0); const dTpur=q2*Rcond(kcur, r_pared_ext, r_PUR_ext, 1.0); const frac=Math.log(r/r_PUR_ext)/Math.log(r_AL_ext/r_PUR_ext); const dTal=q2*Rcond(inp.k_al, r_PUR_ext, r_AL_ext, 1.0); Tlist[i]=Tstart - dTsteel - dTpur - frac*dTal; }
      }
      return {q:q2, r_in, r_pared_ext, r_PUR_ext, r_AL_ext, kpur:kcur, Tlist, rlist, T_AL_solid:T_AL2, h_ext:h_ext2, h_rad:h_rad2};
    }
    T_AL_solid_guess = T_AL2;
    kpur = kcur;
  }
  throw new Error("No converge");
}

function design(inp){
  const Tdew=dewPointC(inp.T_out, inp.phi), target=Tdew+inp.margendew;
  let lo=0.5, hi=20.0, best=null;
  for(let it=0; it<50; it++){
    const mid=(lo+hi)/2;
    const s=solveWithThickness(inp, mid);
    const ok=(s.T_AL_solid>=target);
    if(ok){ best={t_total:mid, ...s}; hi=mid; } else { lo=mid; }
    if(Math.abs(hi-lo)<5e-4) break;
  }
  if(!best){ const s=solveWithThickness(inp, hi); best={t_total:hi, ...s}; }

  // BV
  const Tcut=0+inp.margen0; let r_BV=null;
  for(let i=0;i<best.rlist.length;i++){ const r=best.rlist[i], T=best.Tlist[i]; if(r>=best.r_pared_ext && r<=best.r_PUR_ext && T>=Tcut){ r_BV=r; break; } }
  if(!r_BV){ r_BV=best.r_PUR_ext - 0.5*IN_TO_M; }
  const guard=((best.r_PUR_ext - r_BV)/IN_TO_M);
  if(guard < inp.t_guard){
    const add = (inp.t_guard-guard); const s2=solveWithThickness(inp, best.t_total + add);
    best={t_total:(best.t_total+add), ...s2};
    let rtemp=null; for(let i=0;i<best.rlist.length;i++){ const r=best.rlist[i], T=best.Tlist[i]; if(r>=best.r_pared_ext && r<=best.r_PUR_ext && T>=Tcut){ rtemp=r; break; } } r_BV = rtemp || (best.r_PUR_ext - inp.t_guard*IN_TO_M);
  }
  best.r_BV=r_BV;

  // Capas 4 + 4 + resto (≥3)
  const t_total_in = (best.r_PUR_ext - best.r_pared_ext)/IN_TO_M;
  let capas=[];
  if (t_total_in >= 8.9){ capas=[4.0, 4.0, t_total_in-8.0]; }
  else{ const teq = t_total_in/3; capas=[teq, teq, teq]; }
  // Tope por capa
  let adjusted=[];
  for (let t of capas){
    if (t <= inp.tcapamax) adjusted.push(t);
    else{ let rem=t; while(rem>inp.tcapamax-1e-6){ adjusted.push(inp.tcapamax); rem-=inp.tcapamax; } if (rem>1e-6) adjusted.push(rem); }
  }
  if (adjusted.length<inp.ncapamin){ const teq=t_total_in/3; adjusted=[teq, teq, teq]; }
  if (adjusted.length>inp.ncapamax){ while(adjusted.length>inp.ncapamax){ adjusted[adjusted.length-2]+=adjusted[adjusted.length-1]; adjusted.pop(); } }
  return {best,Tdew,target,capas:adjusted};
}

function run(){
  const inp={ nombre:nombre.value.trim()||'Caso', L:+L.value, d_in:+d_in.value, t_pared:+t_pared.value, T_in:+T_in.value, T_out:+T_out.value, alt:+alt.value, phi:+phi.value, margendew:+margendew.value, margen0:+margen0.value, h_in:+h_in.value, h_out_conv:+h_out_conv.value, eps:+eps.value, k_acero:+k_acero.value, k_a:+k_a.value, k_b:+k_b.value, rho_pur:+rho_pur.value, k_al:+k_al.value, t_al_mm:+t_al_mm.value, t_guard:+t_guard.value, tcapamax:+tcapamax.value, ncapamin:+ncapamin.value, ncapamax:+ncapamax.value };
  const out=design(inp); const best=out.best; const capas=out.capas; const Tdew=out.Tdew; const target=out.target;
  const r_in_in=(inp.d_in/2); const t_total_in=(best.r_PUR_ext - best.r_pared_ext)/IN_TO_M;

  const minOK = 10.9*(1-0.05), maxOK=10.9*(1+0.05);
  const ok = (t_total_in>=minOK && t_total_in<=maxOK);
  const statusText = ok ? `✅ FePe OK (t=${t_total_in.toFixed(2)} in dentro de ±5% de 10.9 in)` : `⚠️ Fuera de rango FePe (t=${t_total_in.toFixed(2)} in; ref=10.9 ±5%)`;

  const tbl=document.getElementById('tabla'); tbl.innerHTML='';
  const add=(k,v,cls='')=>{ const tr=document.createElement('tr'); const a=document.createElement('td'); const b=document.createElement('td'); a.textContent=k; b.textContent=v; if(cls) b.className=cls; tr.appendChild(a); tr.appendChild(b); tbl.appendChild(tr); };
  add('T_amb | φ | T_rocío | Objetivo', `${inp.T_out.toFixed(1)} °C | ${inp.phi.toFixed(2)} | ${Tdew.toFixed(2)} °C | ≥ ${target.toFixed(2)} °C`);
  add('Espesor PUR total', `${t_total_in.toFixed(2)} in`);
  add('q (W/m) | BTU/h·ft', `${best.q.toFixed(2)} | ${(best.q*3.412141633/(1/FT_TO_M)).toFixed(2)}`);
  add('T chaqueta (sólida)', `${best.T_AL_solid.toFixed(2)} °C`);
  add('h_ext (conv + rad)', `${(best.h_ext).toFixed(2)} W/m²·K  (h_rad=${best.h_rad.toFixed(2)})`);
  add('Radios (in): r_in | r_ext PUR | r_ext Al', `${r_in_in.toFixed(3)} | ${(r_in_in+inp.t_pared+t_total_in).toFixed(3)} | ${(r_in_in+inp.t_pared+t_total_in+(inp.t_al_mm/25.4)).toFixed(3)}`);
  add('BV (dentro del PUR, protegida)', `r_BV = ${(best.r_BV/IN_TO_M).toFixed(3)} in | PUR por fuera ≥ ${inp.t_guard.toFixed(2)} in`);
  add('Verificación FePe (10.9 ±5%)', statusText, ok?'status-ok':'status-bad');

  document.getElementById('capas').textContent = 'Capas (acero→exterior): ' + capas.map((t,i)=>`Capa ${i+1}: ${t.toFixed(2)} in`).join('  |  ');
  document.getElementById('bvtext').textContent = 'BV: NO bajo la chaqueta. Ubicar donde T(r) ≥ 0°C+margen y dejar ≥ '+inp.t_guard.toFixed(2)+' in de PUR por fuera.';
  document.getElementById('veritext').textContent = 'Verificación FePe activa — referencia fija 10.9 in (±5%)';

  const r_in = best.rlist.map(v=> v/IN_TO_M); const ctx=document.getElementById('chart').getContext('2d');
  if(window._chart) window._chart.destroy();
  window._chart = new Chart(ctx, {
    type:'line',
    data:{ labels:r_in, datasets:[
      {label:'T(r) sólidos', data:best.Tlist, borderWidth:3, pointRadius:0, tension:0, showLine:true},
      {label:'T_amb', data:r_in.map(()=>inp.T_out), borderWidth:1, pointRadius:0, borderDash:[6,6], showLine:true},
      {label:'T_rocío', data:r_in.map(()=>Tdew), borderWidth:1, pointRadius:0, borderDash:[2,4], showLine:true},
      {label:'0 °C', data:r_in.map(()=>0), borderWidth:1, pointRadius:0, borderDash:[2,4], showLine:true}
    ]},
    options:{ responsive:false, animation:false, scales:{ x:{ title:{display:true,text:'Radio [in]'}, ticks:{maxTicksLimit:12}}, y:{ title:{display:true,text:'Temperatura [°C]'}} }, plugins:{ legend:{display:false}, title:{display:true, text:`SECCIÓN – ${inp.nombre} (PUR=${t_total_in.toFixed(2)} in) ${ok?'✅ FePe OK':'⚠️ Fuera de rango'}` }}},
    plugins:[{ id:'marcas', afterDraw(c){ const {ctx,chartArea:{left,right,top,bottom},scales:{x}}=c; ctx.save(); ctx.fillStyle='#000'; ctx.strokeStyle='#000'; ctx.font='12px Arial';
      const x_pared = x.getPixelForValue(best.r_pared_ext/IN_TO_M);
      const x_pur   = x.getPixelForValue(best.r_PUR_ext/IN_TO_M);
      const x_al    = x.getPixelForValue(best.r_AL_ext/IN_TO_M);
      const x_bv    = x.getPixelForValue(best.r_BV/IN_TO_M);
      let x_c1 = x.getPixelForValue((best.r_pared_ext + 4.0*IN_TO_M)/IN_TO_M);
      let x_c2 = x.getPixelForValue((best.r_pared_ext + 8.0*IN_TO_M)/IN_TO_M);
      if (x_c1 > x_pur) x_c1 = x_pur;
      if (x_c2 > x_pur) x_c2 = x_pur;
      const drawV=(X, dash=false)=>{ ctx.setLineDash(dash?[4,2]:[]); ctx.beginPath(); ctx.moveTo(X,top); ctx.lineTo(X,bottom); ctx.stroke(); ctx.setLineDash([]); };
      drawV(x_pared); drawV(x_c1); drawV(x_c2); drawV(x_bv,true); drawV(x_pur); drawV(x_al);
      const label=(X,text,dy)=>{ const w=ctx.measureText(text).width+8; const h=14; let px=X-w/2; if(px<left+4) px=left+4; if(px+w>right-4) px=right-w-4; const py=top+18+dy; ctx.fillRect(px,py-10,w,h); ctx.fillStyle='#fff'; ctx.fillText(text,px+4,py); ctx.fillStyle='#000'; };
      label(x_pared,'Fin acero',0); label(x_c1,'Fin Capa 1 (4″)',20); label(x_c2,'Fin Capa 2 (4″)',40); label(x_bv,'BV (≥0°C+margen)',60); label(x_pur,'Fin PUR',80); label(x_al,'Chaqueta 1 mm',100);
      ctx.textAlign='right'; ctx.fillText('F. Peluffo – Octubre 2025', right-2, bottom+22); ctx.restore(); } }]
  });
}

document.getElementById('btnDisenar').addEventListener('click', run);
document.getElementById('btnImprimir').addEventListener('click', ()=>window.print());
document.getElementById('btnPNG').addEventListener('click', ()=>{ const a=document.createElement('a'); a.download='lamina_FePe_v03b.png'; a.href=document.getElementById('chart').toDataURL('image/png'); a.click(); });
window.addEventListener('load', run);
</script>
</body>
</html>
